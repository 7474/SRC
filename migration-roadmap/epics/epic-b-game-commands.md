# Epic B: ゲームコマンド

**優先度**: 高  
**スプリント**: 1-2  
**予想工数**: 6-8日  
**リスクレベル**: 高（ゲームプレイ影響）

## 概要

ゲームコマンドシステムには、コアゲームプレイメカニクスとAI動作に直接影響する重要なバグ修正とロジック改善が必要です。

## Issue・タスク

### B.1: AI武器選択バグ修正
**優先度**: 重要  
**工数**: 2日  
**スプリント**: 1

#### 問題ステートメント
AI武器選択ロジックには、ゲームバランスとAI効果に影響する重要なバグが含まれており、AI対戦相手が弱すぎたり強すぎたりする可能性があります。

#### 技術要件
- 武器選択アルゴリズムロジックの修正
- AI武器効果計算の改善
- 適切な射程とダメージ考慮の追加
- 武器タイプ優先度ロジックの実装

#### 影響ファイル
- `SRCCore/Commands/AIWeaponSelection.cs`（プライマリ）
- `SRCCore/AI/WeaponEffectiveness.cs`
- `SRCCore/Combat/WeaponStats.cs`

#### 受け入れ基準
- [ ] AIが戦闘状況に適した武器を選択
- [ ] 武器効果計算が正確
- [ ] 射程考慮が適切に実装
- [ ] AI難易度が武器タイプ全体でバランス
- [ ] ゲームバランスが維持

#### テスト要件
- AI戦闘シナリオテスト
- 武器効果検証
- ゲームバランス検証
- パフォーマンス影響評価

---

### B.2: 攻撃後再移動ロジック実装
**優先度**: 高  
**工数**: 3日  
**スプリント**: 1

#### 問題ステートメント
攻撃後再移動ロジックが不完全で、攻撃後の適切な戦術的移動を妨げており、これはゲームプレイフローに不可欠です。

#### 技術要件
- 攻撃後移動計算の実装
- 移動範囲検証の追加
- 戦術的配置ロジックの実装
- アニメーションとUIフィードバックの追加

#### 影響ファイル
- `SRCCore/Commands/AttackCommand.cs`（プライマリ）
- `SRCCore/Movement/MovementCalculator.cs`
- `SRCCore/Combat/CombatSequence.cs`

#### 受け入れ基準
- [ ] 適切な場合にユニットが攻撃後移動可能
- [ ] 移動範囲が正しく計算される
- [ ] 戦術的配置が動作
- [ ] アニメーションシーケンスがスムーズ
- [ ] UIフィードバックが明確で応答的

#### テスト要件
- 戦闘移動シナリオテスト
- 射程計算検証
- アニメーションスムーズネス検証
- ユーザーエクスペリエンステスト

---

### B.3: コマンドキューシステム最適化
**優先度**: 中  
**工数**: 2日  
**スプリント**: 2

#### 問題ステートメント
コマンドキューシステムは複雑なコマンドシーケンスを処理し、コマンド競合を防ぐための最適化が必要です。

#### 技術要件
- コマンドキュー処理の最適化
- コマンド競合検出の追加
- コマンド優先順位付けの実装
- キュー状態検証の追加

#### 影響ファイル
- `SRCCore/Commands/CommandQueue.cs`（プライマリ）
- `SRCCore/Commands/CommandProcessor.cs`
- `SRCCore/Commands/CommandValidator.cs`

#### 受け入れ基準
- [ ] コマンドキューが効率的に処理される
- [ ] コマンド競合が検出・解決される
- [ ] コマンド優先順位付けが動作
- [ ] キュー状態が常に有効
- [ ] パフォーマンスが改善

#### テスト要件
- コマンドキューストレステスト
- 競合解決検証
- パフォーマンスベンチマーク
- エッジケース処理検証

---

### B.4: 特殊能力コマンド
**優先度**: 中  
**工数**: 3日  
**スプリント**: 2

#### 問題ステートメント
特殊能力コマンド実装が不完全で、複数のTODOコメントが未実装機能を示しています。

#### 技術要件
- 特殊能力実装の完成
- 能力リソース管理の追加
- クールダウンシステムの実装
- ターゲティング検証の追加

#### 影響ファイル
- `SRCCore/Commands/SpecialAbilities/`（複数ファイル）
- `SRCCore/Resources/AbilityResources.cs`
- `SRCCore/Targeting/AbilityTargeting.cs`

#### 受け入れ基準
- [ ] すべての特殊能力が機能的
- [ ] リソース管理が動作
- [ ] クールダウンシステムが実装
- [ ] ターゲティング検証が完了
- [ ] バランステストが通過

#### テスト要件
- 特殊能力機能テスト
- リソース管理検証
- クールダウンタイミング検証
- バランス・ゲームプレイテスト

## 実装戦略

### フェーズ1: 重要修正（スプリント1）
1. AI武器選択アルゴリズムの修正
2. 攻撃後再移動ロジックの実装
3. コア戦闘機能の検証

### フェーズ2: システム改善（スプリント2）
1. コマンドキューシステムの最適化
2. 特殊能力実装の完成
3. パフォーマンス最適化とテスト

### フェーズ3: 磨き・バランス
1. AI動作の微調整
2. 特殊能力のバランス
3. パフォーマンス最適化

## 依存関係

### 外部依存関係
- 戦闘システムテストフレームワーク
- AI動作検証ツール
- パフォーマンスプロファイリングツール

### 内部依存関係
- 戦闘統計システム
- アニメーションフレームワーク
- UIフィードバックシステム
- セーブ/ロードシステム（Epic A）

## リスク評価

### 高リスク
- **ゲームバランス影響**: 変更が競技バランスに影響する可能性
- **AI動作リグレッション**: 修正が新たなAI問題を導入する可能性
- **パフォーマンス低下**: 複雑なロジックが戦闘を遅くする可能性

### 軽減戦略
- 広範囲のゲームプレイテスト
- AI動作検証スイート
- パフォーマンスベンチマーク
- コミュニティベータテスト

## テスト戦略

### 戦闘テストフレームワーク
```
1. 単体テスト: 個別コマンドロジック
2. 統合テスト: コマンドシーケンス検証
3. AIテスト: 武器選択シナリオ
4. パフォーマンステスト: コマンド処理速度
5. バランステスト: ゲームプレイ影響評価
```

### テストシナリオ
- AI対AI戦闘検証
- プレイヤー対AIバランス検証
- 特殊能力効果テスト
- コマンドキューストレステスト

## 完了定義

### Epic完了基準
- [ ] AI武器選択バグ修正済み
- [ ] 攻撃後再移動ロジック実装済み
- [ ] コマンドキュー最適化済み
- [ ] 特殊能力完成
- [ ] ゲームバランス維持
- [ ] パフォーマンス要件達成
- [ ] すべての戦闘シナリオテスト済み
- [ ] AI動作検証済み

### 品質ゲート
- 戦闘機能検証済み
- AI動作テスト合格
- パフォーマンスベンチマーク維持
- ゲームバランス評価完了

---

**Epic所有者**: 開発チーム  
**ゲームプレイレビュアー**: 必要  
**関連Epic**: [A（セーブ/ロード）](./epic-a-save-load.md), [C（式システム）](./epic-c-expression-system.md)  
**GitHubラベル**: `epic:commands`, `priority:high`, `gameplay`, `ai`