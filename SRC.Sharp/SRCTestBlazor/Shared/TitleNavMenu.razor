@using SRCTestBlazor.Models
@using System.Net.Http
@using System.Web

<div class="navbar-item">
    <input type="hidden" @bind="DataIndexUri" />
    <input class="form-control mr-sm-2" type="search" placeholder="Filter" @oninput="OnChangeFilterAsync" />
</div>
<hr class="navbar-divider">
@if (Titles != null)
{
    foreach (var title in Titles)
    {
        <NavLink class="navbar-item" href="@ToTitlePathParam(title)">
            @title.Title
        </NavLink>
    }
}

@code {
    [Inject]
    private HttpClient Http { get; set; }
    [Inject]
    private SrcDataContainer DataContainer { get; set; }

    private string IndexBase { get; set; }
    private string DataIndexUri { get; set; }
    private string BitmapIndexUri { get; set; }
    private string FilterValue { get; set; }

    private ICollection<TitleData> Titles { get; set; }

    // OnInputにすると結構入力に対する応答時間が厳しい
    private async Task OnChangeFilterAsync(ChangeEventArgs e)
    {
        DataContainer.IndexBusy = true;
        // XXX の変化に伴う親の StateHasChanged でこちらも再レンダリングされて時間がかかる

        FilterValue = e.Value?.ToString() ?? "";

        await Task.Run(() =>
        {
            Titles = DataContainer.DataIndex.Titles.Where(x => x.Path.Contains(FilterValue)).ToList();
            DataContainer.IndexBusy = false;
        });
    }

    protected override async Task OnInitializedAsync()
    {
        IndexBase = "https://raw.githubusercontent.com/7474/SRC-Data/master/";
        DataIndexUri = "https://raw.githubusercontent.com/7474/SRC-Data/master/index.json";
        BitmapIndexUri = "https://raw.githubusercontent.com/7474/SRC-Data/master/index-bitmap.json";

        await UpdateIndex();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        //if (!firstRender)
        //{
        //}
    }

    private async Task UpdateIndex()
    {
        DataContainer.IndexBusy = true;
        await DataContainer.LoadBitmapIndex(Http, BitmapIndexUri, IndexBase);
        await DataContainer.LoadDataIndex(Http, DataIndexUri);

        Titles = DataContainer.DataIndex.Titles;
        DataContainer.IndexBusy = false;
    }

    private string ToTitlePathParam(TitleData title)
    {
        return "titles/" + HttpUtility.UrlEncode(IndexBase + title.Path)
            + "/"
            + string.Join("&", title.Files.Select(x => HttpUtility.UrlEncode(x)));
    }

    private bool collapseNavMenu = true;

    private string NavMenuCssClass => collapseNavMenu ? "collapse" : null;

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }
}
