name: CI

on:
  push:
    branches: [ master ]
#     paths: 
#       - .github/workflows/CI.yml
#       - SRC.Sharp/**
  pull_request:
    branches: [ master ]
#     paths: 
#       - .github/workflows/CI.yml
#       - SRC.Sharp/**

jobs:
  build-and-test-srcs:
    runs-on: windows-latest    

    steps:
    - uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore SRC.Sharp/SRC.Sharp.sln

    - name: Build
      run: dotnet build SRC.Sharp/SRC.Sharp.sln --no-restore

    - name: Test
      if: github.event_name == 'pull_request'
      run: dotnet test SRC.Sharp/SRC.Sharp.sln --no-build --verbosity normal

    - name: Test (with coverage)
      if: github.event_name == 'push'
      run: dotnet test SRC.Sharp/SRC.Sharp.sln --no-build --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./TestResults

    - name: Generate Coverage Report
      if: github.event_name == 'push'
      uses: danielpalme/ReportGenerator-GitHub-Action@5.4.3
      with:
        reports: TestResults/**/coverage.cobertura.xml
        targetdir: CoverageReport
        reporttypes: MarkdownSummaryGithub

    - name: Upload Coverage Report to Summary
      if: github.event_name == 'push'
      run: cat CoverageReport/SummaryGithub.md >> $env:GITHUB_STEP_SUMMARY
      shell: pwsh

    # Check NU1605 https://github.com/7474/SRC/pull/262
    - name: Try Publish
      run: dotnet publish SRC.Sharp/SRCSharpForm/SRCSharpForm.csproj -c Release -r win-x64 -p:PublishSingleFile=true --self-contained false
