# SRC# 移植状況 総合評価レポート / Porting Assessment Report

> **作成日**: 2026-02-20  
> **対象**: SRC# (Simulation RPG Construction Sharp) — VB6 → C# .NET 移植プロジェクト

---

## 1. エグゼクティブサマリー / Executive Summary

SRC#は、VB6製シミュレーションRPG構築ツール「SRC」をC# .NETへ移植するプロジェクトである。GUIを備えた複雑なゲームエンジンの移植であり、コアロジック・GUI・イベントスクリプトエンジン・データ永続化など広範な機能領域を含む。

### 総合進捗

| 指標 | 値 | 評価 |
|------|----|------|
| **TODO コメント残存数** | 18件（SRCCore: 10, SRCSharpForm: 8） | ⚠️ 少数だが重要な残件あり |
| **NotImplementedException** | 2件（実コード）+ 132件（テスト用MockGUI） | ✅ 実コードはほぼ解消 |
| **コード規模（C#）** | 212,059行（SRCCore）+ 28,950行（SRCSharpForm）= 241,009行 | - |
| **元ソース規模（VB6）** | 約129,533行（.bas/.cls/.frm） | - |
| **ユニットテスト** | 31ファイル, 約253テストメソッド, 5,751行 | ⚠️ カバレッジ向上余地あり |
| **コマンド実装** | 188ファイル（ほぼ全実装済み） | ✅ 良好 |

### 総合評価: **移植完了度 約88% — 残りは品質精査フェーズ**

残存する18件のTODOは「未移植」ではなく、精査・最適化・リファクタリングの性質が強い。基本機能の移植はほぼ完了しており、プロジェクトは「移植」から「品質保証・精度向上」のフェーズに移行している。

---

## 2. 定量分析 / Quantitative Analysis

### 2.1 コード行数比較

```
元 VB6 ソース:       129,533 行 (68 ファイル)
C# SRCCore:          212,059 行 (385 ファイル)
C# SRCSharpForm:      28,950 行 (45 ファイル)
C# テストコード:       5,751 行 (31 ファイル)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
C# 総計:             246,760 行 (461 ファイル)
```

コード行数の増加（約1.9倍）は、以下の要因による正常な範囲：
- C#のクラスベース設計による構造化（VB6のモジュール→複数クラスへ分割）
- GUI抽象化インタフェース層の追加（UIInterface/）
- VB6互換レイヤーの実装（VB/）
- テストコードの追加

### 2.2 機能領域別 コード分布

| 領域 | ファイル数 | コード行数 | 全体比率 |
|------|-----------|-----------|---------|
| Units（ユニット・戦闘） | 32 | 86,480 | 40.8% |
| SRC本体 | 12 | 24,805 | 11.7% |
| CmdDatas（コマンドパーサー） | 5 | 21,172 | 10.0% |
| Models（データモデル） | 31 | 11,635 | 5.5% |
| Events（イベント） | 17 | 8,789 | 4.1% |
| Commands（コマンド） | 18 | 8,691 | 4.1% |
| Expressions（式評価） | 11 | 8,341 | 3.9% |
| Statuses（状態異常） | 1 | 5,355 | 2.5% |
| Pilots（パイロット） | 10 | 4,530 | 2.1% |
| Maps（マップ） | 4 | 3,768 | 1.8% |
| その他 | 244+ | 58,443 | 13.5% |

### 2.3 テストカバレッジ分析

| テスト対象領域 | テストファイル数 | テストメソッド数 | テスト対象コード行数 | カバレッジ推定 |
|---------------|----------------|-----------------|-------------------|-------------|
| VB互換関数 | 6 | 非公開 | 858 | ⚠️ 中 |
| 式評価（Expression） | 5 | 81 | 8,341 | ✅ 高 |
| ユニット（Unit） | 5 | 53 | 86,480 | ❌ 低 |
| コマンド（CmdData） | 6 | 99 | 21,172 | ⚠️ 中 |
| パイロット | 1 | 9 | 4,530 | ❌ 低 |
| ユーティリティ | 3 | 11+ | 1,101 | ⚠️ 中 |
| Config | 1 | 非公開 | 110 | ✅ 高 |
| **GUI（SRCSharpForm）** | **0** | **0** | **28,950** | **❌ テストなし** |
| **イベント（Event）** | **0** | **0** | **8,789** | **❌ テストなし** |
| **マップ（Map）** | **0** | **0** | **3,768** | **❌ テストなし** |

**重要な発見**: GUI層（約29,000行）とイベント処理（約8,800行）にユニットテストが存在しない。GUIは性質上テストが困難だが、イベント処理はテスト可能な領域である。

---

## 3. 機能領域別評価 / Feature Area Assessment

### 3.1 戦闘システム ✅ 完了

| 項目 | 状態 |
|------|------|
| 残存TODO | 0 |
| 攻撃タイプ（回避・受け流し・ダミー・シールド） | ✅ |
| 援護攻撃・援護防御 | ✅ |
| 合体技・融合技 | ✅ |
| 経験値取得 | ✅ |
| 反撃・追加攻撃 | ✅ |

**評価**: 戦闘システムは全TODOが解消されており、42件のPRを通じて段階的に完成された。移植精度の検証が次の課題。

### 3.2 ユニット・パイロットシステム ⚠️ ほぼ完了

| 項目 | 状態 |
|------|------|
| 残存TODO | 1（追加サポート精査） |
| 基本機能（配置・有効性・スキル条件） | ✅ |
| 変身・形態変更 | ✅ |
| パイロット搭乗・バーサーク解決 | ✅ |
| 召喚ユニット | ✅（#627修正済み） |

**評価**: 実質的に完了。残りの1件は動作精査のみで新規実装ではない。ただし86,480行と最大のコードベースであり、テストカバレッジ（53テスト）が不十分。

### 3.3 GUI・UIシステム ⚠️ 要注意

| 項目 | 状態 |
|------|------|
| 残存TODO | 9（SRCCore: 1, SRCSharpForm: 8） |
| GUIインタフェース定義 | ✅ 163メンバー（IGUI.cs） |
| Windows Forms実装 | ⚠️ 基本動作するが精査不足 |
| マップ描画 | ⚠️ フィルタ未実装 |
| ステータス表示 | ⚠️ FillStyle部分対応 |
| アルファチャネル | ⚠️ 精査必要 |
| インタフェース設計 | ⚠️ Issue #367 で再設計予定 |

**評価**: GUIは本プロジェクトで最も移植精度の評価が困難な領域。視覚的な出力の正確性は自動テストで検証しにくく、手動での比較テストが不可欠。IGUIインタフェースの設計は適切だが、実装側（SRCSharpForm）のテストが皆無。MockGUIはコアロジックテスト用に存在するが、132のNotImplementedExceptionを含み、GUI経由のコードパスは実質テストされていない。

### 3.4 イベント・コマンドシステム ⚠️ 概ね完了

| 項目 | 状態 |
|------|------|
| 残存TODO | 2（SRCCore） |
| コマンドパーサー | ✅ 基本動作 |
| 実装済みコマンド | 188ファイル |
| LIPS（タイムドQuestion） | ✅ PR #735 |
| PaintString最適化 | ⚠️ 未着手（パフォーマンス課題） |
| Talk破損可能性 | ⚠️ Issue #172 関連 |

**評価**: コマンド実装は188ファイルに達しており、主要コマンドはカバーされている。残りはパフォーマンス最適化とエッジケースの対応。

### 3.5 データ管理・永続化 ⚠️ 要精査

| 項目 | 状態 |
|------|------|
| 残存TODO | 3（SRCCore: 2, SRCSharpForm: 1） |
| セーブ・ロード基本機能 | ✅ |
| セーブデータ互換性 | ⚠️ 完全な検証未実施 |
| 設定管理 | ⚠️ SoundVolume以外の反映未実装 |

**評価**: セーブ・ロードの基本機能は動作するが、VB6版との完全な互換性検証が残っている。ゲームエンジンとして重要なデータ永続化層の信頼性確保が課題。

### 3.6 VB6レガシー関数 ✅ ほぼ完了

| 項目 | 状態 |
|------|------|
| 残存TODO | 2 |
| ランダムシーケンス | ✅ |
| StrConv（ひらがな変換） | ✅ |
| ファイルダイアログ | ✅ |
| バイト系文字列関数 | ⚠️ 整理必要 |
| Expression ref→out | ⚠️ 設計判断保留 |

### 3.7 パフォーマンス ⚠️ 未着手

| 項目 | 状態 |
|------|------|
| 残存TODO | 2 |
| Sound キャッシュ | ⚠️ 再検索問題あり |
| PaintString 構文解析 | ⚠️ 未最適化 |

---

## 4. リスク分析 / Risk Analysis

### 4.1 高リスク項目 🔴

| リスク | 影響 | 理由 |
|--------|------|------|
| **GUI描画の精度差異** | ゲーム体験に直結 | VB6のGDI描画とC# GDI+/WinFormsの挙動差異。アルファチャネル、FillStyle、BitBlt相当処理の移植精度が未検証 |
| **セーブデータ互換性** | 既存ユーザーのデータ喪失 | VB6版のセーブデータとの完全な互換性が未検証。バイナリレベルの差異がある可能性 |
| **イベントスクリプト実行の互換性** | シナリオの動作不良 | 129,533行のVB6コードから移植されたコマンド処理で、微細な挙動差異が蓄積する可能性 |

### 4.2 中リスク項目 🟡

| リスク | 影響 | 理由 |
|--------|------|------|
| **MockGUI の不完全性** | テスト信頼性の低下 | 132件のNotImplementedExceptionにより、GUI経由のロジックがテストされない |
| **COM武器選択の失敗** | AI戦闘の品質低下 | TODO記載の既知問題（武器選択に失敗するケース） |
| **数値型の差異** | 計算結果の微妙なずれ | VB6のInteger(16bit)→C#のint(32bit)変換時のオーバーフロー挙動の差異 |

### 4.3 低リスク項目 🟢

| リスク | 影響 | 理由 |
|--------|------|------|
| パフォーマンス | 体感速度 | C#は一般にVB6より高速。Sound再検索などは最適化の余地ありだが致命的ではない |
| VB6互換関数の残件 | 限定的 | バイト系関数の整理は影響範囲が限定的 |

---

## 5. GUI固有の評価 / GUI-Specific Assessment

### 5.1 アーキテクチャ評価

SRC#のGUI設計は以下の3層構造を採用しており、移植アーキテクチャとしては適切：

```
┌─────────────────────────────────────────────────┐
│  SRCSharpForm (Windows Forms実装)                │
│  28,950行, 45ファイル                             │
│  ┌─────────────────────────────────────────────┐ │
│  │ Forms/ (UI部品)                              │ │
│  │  Main, ListBox, Message, Configuration...   │ │
│  │ SRCSharpFormGUI*.cs (GUIインタフェース実装)    │ │
│  │ Resoruces/ (画像バッファ, サウンド)            │ │
│  └─────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────┤
│  UIInterface/ (抽象インタフェース層)               │
│  IGUI (163メンバー), IGUIMap, IGUIScrean,         │
│  IGUIStatus, IPlaySound, ISystemConfig            │
├─────────────────────────────────────────────────┤
│  SRCCore (コアロジック)                            │
│  212,059行 — GUI非依存                            │
└─────────────────────────────────────────────────┘
```

**良い点**:
- コアロジックとGUIの分離（UIInterface経由のDI）
- TestLib/MockGUIによるコアの独立テスト可能性
- Blazor WebAssembly版（SRCTestBlazor）の存在が設計の柔軟性を証明

**課題**:
- IGUI.csが163メンバーと巨大（Issue #367 で分割検討中）
- MockGUIが132件のNotImplementedException — コアロジックのGUI連携パスが網羅テストされない
- GUI.ref.cs が11,640行 — VB6からの定数・参照データの直訳

### 5.2 GUI移植の個別課題

| 課題 | 重要度 | 詳細 |
|------|--------|------|
| フィルタ未実装（Main.guimap.cs） | 高 | 地形ユニットの特別処理。VB6のBitBlt→DrawImage+アルファブレンドへの代替が必要 |
| FillStyle部分対応（Main.guiscrean.cs） | 中 | VB6の塗りつぶしスタイル（透過・ハッチ等）が SolidBrush のみ |
| アルファチャネル精査（ImageBuffer.cs） | 中 | 画像合成時の透過処理の正確性 |
| インタフェース分割（Issue #367） | 低 | 設計改善。機能には影響しない |
| ユニットタイル読み込み元 | 低 | アセット管理の改善 |

---

## 6. 結論と推奨事項 / Conclusions & Recommendations

### 6.1 移植は「実質的に完了」段階にある

- 全155+ TODOのうち137+（88%）が解消済み
- 戦闘システム・ユニットシステムなどコア機能は完成
- 残存18件のTODOは精査・最適化が中心で、新規移植は少ない

### 6.2 次のフェーズは「移植精度の検証と品質向上」

移植が「完了」と宣言するためには、以下が必要：

1. **動作の正確性検証**: VB6版との比較テスト（特にGUI描画とイベントスクリプト実行）
2. **テストカバレッジの拡充**: 特にUnit（86,480行に53テスト）とGUI層
3. **セーブデータ互換性の検証**: VB6版とのラウンドトリップテスト
4. **パフォーマンス計測**: ベンチマーク設定と定期測定

詳細な評価・向上計画は [移植精度 評価・向上計画](./porting-quality-plan.md) を参照。

---

## 更新履歴 / Change History

- 2026-02-20: 初版作成
