# SRC# 移植精度 評価・向上計画 / Porting Quality Evaluation & Improvement Plan

> **作成日**: 2026-02-20  
> **前提**: [移植状況 総合評価レポート](./porting-assessment.md) を参照  
> **対象**: SRC# (Simulation RPG Construction Sharp) — GUIを備えた複雑なゲームエンジン

---

## 1. 目的 / Purpose

SRC#の移植作業は約88%が完了し、残りのTODOは18件に縮小した。しかし「コードの移植」と「動作の正確性」は別の問題である。本計画は、移植されたコードがVB6版と同等の動作を保証するための**精度評価**の方法論と、継続的な**品質向上**のロードマップを定義する。

GUIを備えた複雑なゲームエンジンの移植精度は、ロジック層・描画層・スクリプトエンジン層を横断的にカバーする検証が必要であり、単純なユニットテストだけでは不十分である。

---

## 2. 精度評価の方法論 / Evaluation Methodology

### 2.1 評価の3層モデル

移植精度を以下の3層で独立に評価する：

```
┌──────────────────────────────────────────────────────────┐
│ 層3: E2E検証（エンドツーエンド）                           │
│   シナリオ通しプレイ → VB6版との動作比較                    │
│   手動テスト + スクリーンショット比較                       │
└──────────────────────────────────────────────────────────┘
                          ▲
┌──────────────────────────────────────────────────────────┐
│ 層2: 統合テスト（コアロジック + GUI接続点）                  │
│   イベントスクリプト実行 → 期待状態の検証                   │
│   セーブデータのラウンドトリップ                            │
│   MockGUI拡張によるGUI連携テスト                           │
└──────────────────────────────────────────────────────────┘
                          ▲
┌──────────────────────────────────────────────────────────┐
│ 層1: ユニットテスト（関数・メソッド単位）                    │
│   計算ロジック、VB6互換関数、式評価エンジン                  │
│   コマンドパーサー、データモデル                            │
└──────────────────────────────────────────────────────────┘
```

### 2.2 各層の評価基準

#### 層1: ユニットテスト

| 基準 | 目標値 | 現状 |
|------|--------|------|
| テストメソッド数 | 500+ | 約253 |
| コードカバレッジ（SRCCore） | 40%以上 | 未計測（推定10-15%） |
| 重点対象 | Units/, Events/, CmdDatas/ | Units/のみ一部 |

**具体的な強化領域**:

| 対象コード | 現テスト数 | 目標テスト数 | 優先度 |
|-----------|-----------|-------------|--------|
| Units/（86,480行） | 53 | 150+ | 🔴 高 |
| Events/（8,789行） | 0 | 30+ | 🔴 高 |
| CmdDatas/（21,172行） | 99 | 150+ | 🟡 中 |
| Pilots/（4,530行） | 9 | 30+ | 🟡 中 |
| Maps/（3,768行） | 0 | 15+ | 🟡 中 |
| Expressions/（8,341行） | 81 | 100+ | 🟢 低（既に良好） |

#### 層2: 統合テスト

| テスト種別 | 内容 | 実施方法 |
|-----------|------|---------|
| **イベントスクリプト実行テスト** | SRCイベントファイル（.eve）を読み込み、期待される状態変化を検証 | MSTestベースで、テスト用.eveファイルを実行 |
| **セーブデータラウンドトリップ** | Save→Load後に状態が一致することを検証 | シリアライズ前後の比較テスト |
| **コマンド連携テスト** | 複数コマンドの組み合わせ実行 | SwitchDoLoopCmdTests.csを参考に拡張 |
| **MockGUI拡張テスト** | MockGUIの主要プロパティをstub実装し、GUI連携パスのコアロジックを検証 | MockGUIのNotImplementedExceptionを段階的に解消 |

#### 層3: E2E検証（エンドツーエンド）

| テスト種別 | 内容 | 実施方法 |
|-----------|------|---------|
| **サンプルシナリオ通しプレイ** | SRC付属サンプルシナリオの完走確認 | 手動テスト + 結果記録 |
| **VB6版比較テスト** | 同一シナリオをVB6版とSRC#版で実行し、画面・動作を比較 | スクリーンショット比較 |
| **回帰テストシナリオ** | 修正後の再確認用シナリオ集 | [SRC-SharpTestScenario](https://github.com/7474/SRC-SharpTestScenario) |
| **WinAppDriverテスト** | Windows Forms UIの自動操作テスト | 既存のSRCSharpFormTestWinAppDriver |

---

## 3. GUI精度評価の特別計画 / GUI-Specific Quality Plan

GUIを備えたゲームエンジンの移植では、描画の正確性が体験品質に直結する。以下は GUI 固有の評価計画。

### 3.1 視覚的回帰テスト（Visual Regression Testing）

**目的**: GUI描画がVB6版と視覚的に一致することの検証

**手法**:
1. VB6版で各画面のスクリーンショットを基準画像（ゴールデンイメージ）として保存
2. SRC#版で同一条件の画面をキャプチャ
3. ピクセル差分比較（許容差を設定）

**対象画面**:

| 画面 | 優先度 | 関連ファイル |
|------|--------|-------------|
| マップ画面（ユニット配置あり） | 🔴 高 | Main.guimap.cs |
| ステータス画面 | 🔴 高 | Main.guistatus.cs |
| 戦闘アニメーション | 🟡 中 | SRCSharpFormGUI.draw.cs |
| メッセージウィンドウ | 🟡 中 | SRCSharpFormGUI.message.cs |
| リストボックス（武器・アビリティ選択） | 🟡 中 | ListBox.cs |
| 設定画面 | 🟢 低 | Configuration.cs |

### 3.2 描画精度の既知課題

| 課題 | リスク | 対応方針 |
|------|--------|---------|
| **BitBlt → DrawImage 変換** | VB6のBitBltラスタオペレーションとGDI+ DrawImageの挙動差異 | テストシナリオで重点検証。ColorMatrix等で補正 |
| **アルファチャネル精査** | 半透明描画の結果差異 | ImageBuffer.csのブレンド処理をVB6版と比較 |
| **FillStyle対応** | VB6の6種FillStyleに対しSolidBrushのみ実装 | HatchBrush等を追加実装 |
| **座標系の差異** | VB6のTwip(15=1px)とC#のピクセルの変換精度 | 丸め処理のテスト |
| **フォントレンダリング** | OS・環境依存のフォント描画差異 | フォールバックフォント指定、描画位置の許容差設定 |

### 3.3 GUI品質メトリクス

| メトリクス | 測定方法 | 目標 |
|-----------|---------|------|
| 画面一致率 | ゴールデンイメージとのピクセル差分比率 | 95%以上 |
| 操作応答時間 | マウスクリック→画面更新までの時間 | 100ms以内 |
| マップスクロール速度 | フレームレート測定 | 30fps以上 |
| メモリ使用量 | プロファイラ測定 | VB6版の2倍以内 |

---

## 4. 品質向上ロードマップ / Quality Improvement Roadmap

### Phase Q1: 基盤構築（2026年Q2）— テストインフラ整備

**目標**: 精度評価の基盤を構築し、自動化可能な検証パイプラインを確立する。

| タスク | 成果物 | 優先度 |
|--------|--------|--------|
| MockGUI の主要プロパティ stub 化（30件以上） | MockGUI.cs の更新 | 🔴 高 |
| Units/ のユニットテスト追加（+100テスト） | Unit*.Tests.cs | 🔴 高 |
| Events/ のユニットテスト作成（+30テスト） | Event*.Tests.cs | 🔴 高 |
| コードカバレッジ CI レポートの閾値設定 | CI/CD ワークフロー更新 | 🟡 中 |
| テスト用イベントスクリプト（.eve）の作成 | テストデータ | 🟡 中 |

**KPI**:
- テストメソッド数: 253 → 400+
- コードカバレッジ: 推定15% → 25%
- MockGUI NotImplementedException: 132 → 100以下

### Phase Q2: コアロジック検証（2026年Q3）— 精度差異の特定と修正

**目標**: VB6版との動作差異を体系的に特定し、修正する。

| タスク | 成果物 | 優先度 |
|--------|--------|--------|
| 戦闘計算結果の比較テスト（VB6 vs SRC#） | 比較テストレポート | 🔴 高 |
| セーブデータラウンドトリップテスト実装 | Save/Load テスト | 🔴 高 |
| コマンド実行結果の差異リスト作成 | 差異一覧ドキュメント | 🟡 中 |
| 数値精度（整数型・浮動小数点型）の差異検証 | 精度検証テスト | 🟡 中 |
| 残存TODO 18件の完全解消 | コード修正 | 🟡 中 |

**KPI**:
- 発見された動作差異の件数と修正率
- セーブデータ互換性テスト合格率: 100%
- 残存TODO: 18 → 0

### Phase Q3: GUI品質検証（2026年Q4）— 視覚的精度の確保

**目標**: GUI描画の精度を検証し、視覚的な差異を修正する。

| タスク | 成果物 | 優先度 |
|--------|--------|--------|
| ゴールデンイメージの作成（VB6版スクリーンショット集） | 基準画像セット | 🔴 高 |
| 主要画面の視覚比較テスト実施 | 差異レポート | 🔴 高 |
| アルファチャネル・FillStyle 修正 | コード修正 | 🟡 中 |
| フィルタ実装（地形ユニット描画） | Main.guimap.cs 更新 | 🟡 中 |
| WinAppDriver テストの拡充 | UI自動テスト | 🟢 低 |

**KPI**:
- 主要画面の視覚一致率: 95%以上
- GUI 関連バグの発見・修正件数
- WinAppDriver テストケース数

### Phase Q4: 統合・リリース品質（2027年Q1）— リリース準備

**目標**: リリース品質に到達し、v3.1.0（正式版）のリリース判定を行う。

| タスク | 成果物 | 優先度 |
|--------|--------|--------|
| サンプルシナリオ完走テスト | テスト結果レポート | 🔴 高 |
| 外部テスターによるプレイテスト | フィードバックレポート | 🔴 高 |
| パフォーマンスベンチマーク実施 | 性能レポート | 🟡 中 |
| リリースノート作成 | リリースドキュメント | 🟡 中 |
| IGUI インタフェース分割（Issue #367） | リファクタリング | 🟢 低 |

**KPI**:
- サンプルシナリオ完走率: 100%
- クリティカルバグ: 0件
- テストメソッド数: 500+
- コードカバレッジ: 40%+

---

## 5. 精度評価チェックリスト / Quality Checklist

リリース前に確認すべき項目の一覧。各項目を「✅ 合格 / ⚠️ 条件付き / ❌ 不合格」で評価する。

### 5.1 機能の正確性

- [ ] 戦闘計算（ダメージ・命中・回避）がVB6版と一致
- [ ] ユニット能力値の計算がVB6版と一致
- [ ] スキル・アビリティの効果がVB6版と一致
- [ ] イベントコマンドの実行結果がVB6版と一致
- [ ] 式評価エンジン（Expression）の結果がVB6版と一致

### 5.2 データ互換性

- [ ] VB6版のセーブデータを SRC# で読み込める
- [ ] SRC# のセーブデータを正常にロードできる
- [ ] 設定ファイル（.ini）の読み書きが正常
- [ ] シナリオデータ（.eve, .txt等）の読み込みが正常

### 5.3 GUI の正確性

- [ ] マップ画面の描画がVB6版と視覚的に一致
- [ ] ステータス画面の表示が正確
- [ ] メッセージウィンドウの表示が正確
- [ ] リストボックス（武器・アビリティ選択等）の表示が正確
- [ ] 戦闘アニメーションの再生が正常
- [ ] ダイアログ・設定画面の操作が正常

### 5.4 パフォーマンス

- [ ] シナリオロード時間がVB6版と同等以下
- [ ] マップスクロールが滑らか（30fps以上）
- [ ] 戦闘処理の応答時間が許容範囲内
- [ ] メモリ使用量が許容範囲内

---

## 6. 継続的品質管理 / Continuous Quality Management

### 6.1 CI/CDパイプラインでの品質ゲート

```
PR作成 → ビルド → ユニットテスト → コードカバレッジ → マージ
                      ▲                    ▲
                    合格必須            閾値チェック
```

**現在のCI状態**: ユニットテスト実行 + コードカバレッジ収集済み（PR #738）

**追加すべきゲート**:
1. コードカバレッジの閾値（新規コードに対して80%以上を推奨）
2. 静的解析（Roslyn Analyzer等）の導入検討
3. パフォーマンスリグレッションテスト（将来的に）

### 6.2 品質ダッシュボード

定期的に以下のメトリクスを追跡する：

| メトリクス | 計測頻度 | 目標 |
|-----------|---------|------|
| テストメソッド数 | PR毎 | 単調増加 |
| コードカバレッジ | PR毎 | 40%以上 |
| 残存TODO数 | 週次 | 0 |
| 発見バグ数/修正バグ数 | 週次 | 修正率90%以上 |
| サンプルシナリオ通過率 | 月次 | 100% |

### 6.3 Copilotエージェントによる自動品質向上

既存のCopilot自律運用モードを活用し、以下のコマンドで品質向上を推進する：

```
@copilot ユニットテストを補完してください
@copilot 移植精度を検証してください
```

---

## 7. まとめ / Summary

### 現状の精度評価

| 領域 | 移植完了度 | 精度確信度 | 理由 |
|------|-----------|-----------|------|
| 戦闘システム | ✅ 100% | ⚠️ 中 | 実装完了だが網羅的テスト不足 |
| ユニット・パイロット | ✅ 99% | ⚠️ 中 | テストカバレッジ低（53/86K行） |
| GUI・UI | ⚠️ 85% | ❌ 低 | テストなし、視覚比較未実施 |
| イベント・コマンド | ⚠️ 95% | ⚠️ 中 | 188コマンド実装済み、統合テスト不足 |
| データ管理 | ⚠️ 90% | ❌ 低 | 互換性検証未実施 |
| VB6互換 | ✅ 95% | ✅ 高 | テストカバレッジ比較的高い |

### 今後の最重要アクション（Top 3）

1. **MockGUIの拡充とUnit層テスト追加** — 最大コードベース（86K行）のテスト不足解消
2. **セーブデータ互換性テストの実施** — データ喪失リスクの排除
3. **サンプルシナリオ通しプレイ検証** — E2Eでの動作確認、GUI精度の視覚的検証

---

## 更新履歴 / Change History

- 2026-02-20: 初版作成
